<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNIPER AMBUSH V2.0 | å¸¶æ­·å²ç´€éŒ„ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: #FFD700; font-family: 'Courier New', monospace; }
        .gold-border { border: 1px solid #FFD700; }
        .ambush-card { border: 2px solid #ff0000; box-shadow: 0 0 20px #ff0000; animation: blink 0.8s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .bg-zinc-900 { background-color: #0f0f0f; }
        .status-active { color: #00ff00; text-shadow: 0 0 10px #00ff00; }
        .status-inactive { color: #ff0000; text-shadow: 0 0 10px #ff0000; }
        .dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .pulse { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        #logContainer::-webkit-scrollbar { width: 5px; }
        #logContainer::-webkit-scrollbar-thumb { background: #555; }
    </style>
</head>
<body class="p-4">
    <div class="flex flex-col md:flex-row justify-between items-center border-b border-yellow-700 pb-4 mb-6">
        <div class="flex items-center gap-4">
            <h1 class="text-3xl font-black text-yellow-500 tracking-tighter text-shadow-lg">âš¡ SNIPER V2.0</h1>
            <button id="masterBtn" onclick="toggleSystem()" class="flex items-center bg-zinc-900 border gold-border px-4 py-1 rounded-full hover:bg-zinc-800">
                <span id="statusDot" class="dot bg-red-600"></span>
                <span id="statusText" class="status-inactive font-bold uppercase">OFFLINE</span>
            </button>
        </div>
        <div class="flex gap-2 mt-4 md:mt-0">
            <input id="coinSearch" type="text" placeholder="æœå°‹å¹£ç¨® (AXS)" class="bg-black border gold-border p-2 text-white w-32 md:w-40">
            <button onclick="pinCoin()" class="bg-yellow-600 text-black px-6 py-2 font-black hover:bg-yellow-400">é‡˜é¸</button>
        </div>
    </div>

    <div class="flex flex-col lg:flex-row gap-6">
        <div class="flex-1">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">ğŸ“¡ å³æ™‚ç›£æ§å€ <span class="text-[10px] text-zinc-500 font-normal">æ¯ 8 ç§’åŒæ­¥ä¸€æ¬¡</span></h2>
            <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-white"></div>
        </div>

        <div class="w-full lg:w-80">
            <h2 class="text-xl font-bold mb-4 text-red-500 flex items-center gap-2">ğŸ“‚ çµæ®ºæ—¥èªŒ <button onclick="clearLogs()" class="text-[10px] text-zinc-500 underline ml-auto">æ¸…é™¤å…¨éƒ¨</button></h2>
            <div id="logContainer" class="bg-zinc-900 border border-zinc-800 p-2 h-[500px] overflow-y-auto space-y-2 text-[12px]">
                </div>
        </div>
    </div>

    <script>
        const EXCLUDE_LIST = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'BNBUSDT', 'BNXUSDT'];
        const SLOPE_THRESHOLD = -0.5;
        let pinnedCoins = [];
        let coinHistory = {};
        let joinTime = {};
        let loggedCoins = new Set(); // é˜²æ­¢åŒä¸€æ³¢è¡Œæƒ…é‡è¤‡æ´—ç‰ˆæ—¥èªŒ
        let isRunning = false;
        let timer = null;

        function toggleSystem() {
            isRunning = !isRunning;
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            if (isRunning) {
                dot.className = "dot bg-green-500 pulse";
                text.innerText = "ONLINE (8s)";
                text.className = "status-active font-bold";
                updateData();
                timer = setInterval(updateData, 8000);
            } else {
                dot.className = "dot bg-red-600";
                text.innerText = "OFFLINE";
                text.className = "status-inactive font-bold";
                clearInterval(timer);
            }
        }

        function pinCoin() {
            let s = document.getElementById('coinSearch').value.toUpperCase().trim();
            if (!s) return;
            if (!s.endsWith('USDT')) s += 'USDT';
            if (!pinnedCoins.includes(s)) {
                pinnedCoins.push(s);
                joinTime[s] = new Date().toLocaleTimeString('zh-TW', {hour12: false});
            }
            document.getElementById('coinSearch').value = '';
            if (isRunning) updateData();
        }

        function removeCoin(s) {
            pinnedCoins = pinnedCoins.filter(c => c !== s);
            delete coinHistory[s];
            delete joinTime[s];
            render();
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            loggedCoins.clear();
        }

        function addLog(s, f, slope) {
            const logContainer = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString('zh-TW', {hour12: false});
            const entry = document.createElement('div');
            entry.className = "border-l-2 border-red-600 pl-2 py-1 bg-black mb-1";
            entry.innerHTML = `
                <div class="flex justify-between">
                    <span class="font-bold text-white text-[14px]">${s.replace('USDT', '')}</span>
                    <span class="text-zinc-500">${time}</span>
                </div>
                <div class="flex justify-between text-red-500">
                    <span>è³‡è²»: ${(f * 100).toFixed(4)}%</span>
                    <span>æ–œç‡: ${(slope * 100).toFixed(1)}%</span>
                </div>
            `;
            logContainer.prepend(entry);
        }

        async function updateData() {
            if (!isRunning) return;
            try {
                const res = await fetch('https://fapi.binance.com/fapi/v1/premiumIndex');
                const allData = await res.json();
                
                allData.forEach(coin => {
                    const s = coin.symbol;
                    if (EXCLUDE_LIST.includes(s)) return;
                    const f = parseFloat(coin.lastFundingRate);
                    
                    if (!coinHistory[s]) coinHistory[s] = [];
                    coinHistory[s].push(f);
                    if (coinHistory[s].length > 75) coinHistory[s].shift();

                    if (coinHistory[s].length >= 75) {
                        const fPast = coinHistory[s][0];
                        const slope = (f - fPast) / Math.abs(fPast);
                        
                        if (f <= -0.0003 && slope <= SLOPE_THRESHOLD) {
                            if (!pinnedCoins.includes(s)) {
                                pinnedCoins.unshift(s);
                                joinTime[s] = new Date().toLocaleTimeString('zh-TW', {hour12: false});
                            }
                            // å¦‚æœæ˜¯æ–°ç™¼ç¾æˆ–æ–œç‡å¤§å¹…åˆ·æ–°ï¼Œå¯«å…¥æ—¥èªŒ (æ¯å°æ™‚æ¯å¹£ç¨®æœ€å¤šè¨˜éŒ„ä¸€æ¬¡ï¼Œé¿å…æ´—ç‰ˆ)
                            const logKey = `${s}_${new Date().getHours()}`;
                            if (!loggedCoins.has(logKey)) {
                                addLog(s, f, slope);
                                loggedCoins.add(logKey);
                            }
                        }
                    }
                });
                render(allData);
            } catch (e) { console.error("API è«‹æ±‚å¤±æ•—"); }
        }

        function render(allData = []) {
            const container = document.getElementById('dashboard');
            container.innerHTML = '';
            pinnedCoins.forEach(s => {
                const data = allData.find(c => c.symbol === s);
                const fNow = data ? parseFloat(data.lastFundingRate) : 0;
                const history = coinHistory[s] || [fNow];
                const fPast = history[0];
                const slope = history.length >= 75 ? (fNow - fPast) / Math.abs(fPast) : 0;
                const isAmbush = fNow <= -0.0003 && slope <= SLOPE_THRESHOLD;

                const card = document.createElement('div');
                card.className = `p-4 bg-zinc-900 rounded ${isAmbush ? 'ambush-card' : 'gold-border'}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="text-[10px] font-bold ${isAmbush ? 'text-red-500' : 'text-zinc-500'}">${isAmbush ? 'âš¡ åŸ‹ä¼é€²å ´' : 'ç›£è¦–ä¸­'}</span>
                        <div class="text-right">
                            <p class="text-[10px] text-zinc-500">ä¸Šæ¦œæ™‚åˆ»</p>
                            <p class="text-xs text-yellow-500 font-bold">${joinTime[s] || '--:--:--'}</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-end mt-2">
                        <h2 class="text-4xl font-black">${s.replace('USDT', '')}</h2>
                        <div class="text-right">
                            <p class="text-lg font-bold ${fNow < 0 ? 'text-red-500' : 'text-green-500'}">${(fNow * 100).toFixed(4)}%</p>
                            <p class="text-[10px] text-zinc-400">æ–œç‡: ${(slope * 100).toFixed(1)}%</p>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-between">
                        <span class="text-[9px] text-zinc-600 italic">Binance Futures Live</span>
                        <button onclick="removeCoin('${s}')" class="text-[10px] text-zinc-500 hover:text-white underline">ç§»é™¤ç›£æ§</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
    </script>
</body>
</html>
