<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNIPER AMBUSH V3.0 | å¯¦æˆ°å®šè£½ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: #FFD700; font-family: 'Courier New', monospace; }
        .gold-border { border: 1px solid #FFD700; }
        .ambush-card { border: 2px solid #ff0000; box-shadow: 0 0 20px #ff0000; animation: blink 0.8s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .bg-zinc-900 { background-color: #111; }
        .status-active { color: #00ff00; text-shadow: 0 0 10px #00ff00; }
        .dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .pulse { animation: pulse-dot 1s infinite; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body class="p-4">
    <div class="border-b border-yellow-700 pb-4 mb-6">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <h1 class="text-3xl font-black text-yellow-500 tracking-tighter">âš¡ SNIPER V3.0</h1>
                <button id="masterBtn" onclick="toggleSystem()" class="flex items-center bg-zinc-900 border gold-border px-6 py-2 rounded-full hover:bg-zinc-800">
                    <span id="statusDot" class="dot bg-red-600"></span>
                    <span id="statusText" class="text-red-500 font-bold uppercase">SYSTEM OFFLINE</span>
                </button>
            </div>
            
            <div class="flex gap-3">
                <button onclick="testPush()" class="bg-blue-700 text-white px-4 py-2 font-bold rounded hover:bg-blue-600 transition">æ¸¬è©¦ PUSHOVER æ¨æ’­</button>
                <div class="flex items-center gap-2 bg-zinc-900 border border-zinc-700 px-3 py-1 rounded">
                    <span class="text-[10px] text-zinc-500">æ¨æ’­ç‹€æ…‹:</span>
                    <span id="pushStatus" class="text-[10px] text-green-500 font-bold italic font-mono">READY</span>
                </div>
            </div>
        </div>
    </div>

    <div class="flex flex-col lg:flex-row gap-6">
        <div class="flex-1">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">ğŸ“¡ å³æ™‚çµæ®ºå€ <span class="text-[10px] text-zinc-600 font-normal italic">(-20% è§€å¯Ÿ | -50%+OI çµæ®º)</span></h2>
            <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <div class="w-full lg:w-84">
            <h2 class="text-xl font-bold mb-4 text-red-500 flex justify-between items-center">
                ğŸ“‚ çµæ®ºæ—¥èªŒ 
                <button onclick="clearLogs()" class="text-[10px] text-zinc-500 underline">æ¸…é™¤ç´€éŒ„</button>
            </h2>
            <div id="logContainer" class="bg-zinc-900 border border-zinc-800 p-2 h-[600px] overflow-y-auto text-[12px] space-y-2">
                <div class="text-zinc-700 italic text-center py-10">ç­‰å¾…è¨Šè™Ÿè§¸ç™¼...</div>
            </div>
        </div>
    </div>

    <script>
        // ä½ çš„å°ˆå±¬é…ç½® (å·²å¡«å…¥è¨˜æ†¶è³‡è¨Š)
        const CONFIG = {
            PO_USER: "Gkhqyhobnxzjfwgvaiyp347m1jkhn4",
            PO_TOKEN: "acyoe3sz15x4n91r1349fdcau7x6pw",
            EXCLUDE: ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'BNBUSDT', 'BNXUSDT'],
            OBSERVE_SLOPE: -0.2, // 20% é€²å…¥è§€å¯Ÿ
            HUNT_SLOPE: -0.5,    // 50% å•Ÿå‹•çµæ®º
            INTERVAL: 8000       // 8ç§’é »ç‡
        };

        let pinnedCoins = [];
        let coinHistory = {};
        let oiHistory = {}; 
        let joinTime = {};
        let lastPushTime = {}; // ç”¨æ–¼æ¨æ’­å†·å»
        let isRunning = false;
        let timer = null;

        function toggleSystem() {
            isRunning = !isRunning;
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            if (isRunning) {
                dot.className = "dot bg-green-500 pulse";
                text.innerText = "SYSTEM ONLINE (8s)";
                text.className = "text-green-500 font-bold uppercase";
                updateData();
                timer = setInterval(updateData, CONFIG.INTERVAL);
            } else {
                dot.className = "dot bg-red-600";
                text.innerText = "SYSTEM OFFLINE";
                text.className = "text-red-500 font-bold uppercase";
                clearInterval(timer);
            }
        }

        async function sendPush(title, message) {
            try {
                await fetch('https://api.pushover.net/1/messages.json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `token=${CONFIG.PO_TOKEN}&user=${CONFIG.PO_USER}&title=${encodeURIComponent(title)}&message=${encodeURIComponent(message)}&priority=1`
                });
            } catch(e) { console.error("Pushover å¤±æ•—", e); }
        }

        async function testPush() {
            await sendPush("Sniper V3.0 æ¸¬è©¦", "é€™æ˜¯ä¸€å‰‡æ¸¬è©¦é€šçŸ¥ï¼Œä»£è¡¨æ¨æ’­é…ç½®æ­£ç¢ºï¼");
            alert("æ¸¬è©¦æŒ‡ä»¤å·²ç™¼é€ï¼");
        }

        async function getOI(symbol) {
            try {
                const res = await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${symbol}`);
                const data = await res.json();
                return parseFloat(data.openInterest);
            } catch(e) { return null; }
        }

        async function updateData() {
            if (!isRunning) return;
            try {
                const res = await fetch('https://fapi.binance.com/fapi/v1/premiumIndex');
                const allData = await res.json();
                
                for (const coin of allData) {
                    const s = coin.symbol;
                    if (CONFIG.EXCLUDE.includes(s)) continue;
                    const fNow = parseFloat(coin.lastFundingRate);
                    
                    if (!coinHistory[s]) coinHistory[s] = [];
                    coinHistory[s].push(fNow);
                    if (coinHistory[s].length > 75) coinHistory[s].shift();

                    if (coinHistory[s].length >= 75) {
                        const fPast = coinHistory[s][0];
                        const slope = (fNow - fPast) / Math.abs(fPast);
                        
                        // 1. é€²å…¥è§€å¯Ÿæ¢ä»¶ (-20% æ–œç‡)
                        if (fNow <= -0.0003 && slope <= CONFIG.OBSERVE_SLOPE) {
                            if (!pinnedCoins.includes(s)) {
                                pinnedCoins.unshift(s);
                                joinTime[s] = new Date().toLocaleTimeString('zh-TW', {hour12: false});
                            }

                            // 2. å–®ä¸€å¹£ç¨® OI æƒæ
                            const currentOI = await getOI(s);
                            if (currentOI) {
                                const oldOI = oiHistory[s] || currentOI;
                                const oiChange = (currentOI - oldOI) / oldOI;
                                
                                // 3. çµæ®ºè§¸ç™¼ (-50% æ–œç‡ + OI å¢åŠ )
                                if (slope <= CONFIG.HUNT_SLOPE && currentOI > oldOI) {
                                    const now = Date.now();
                                    // å†·å»æ©Ÿåˆ¶ï¼šåŒä¸€å€‹å¹£ 30 åˆ†é˜å…§åªæ¨æ’­ä¸€æ¬¡
                                    if (!lastPushTime[s] || (now - lastPushTime[s] > 1800000)) {
                                        sendPush(`ğŸ”¥ è¶…ç´šåŸ‹ä¼: ${s.replace('USDT','')}`, 
                                            `è³‡è²»: ${(fNow*100).toFixed(4)}%\næ–œç‡: ${(slope*100).toFixed(1)}%\nOI å¢åŠ : ${(oiChange*100).toFixed(2)}%`);
                                        addLog(s, fNow, slope, oiChange, true);
                                        lastPushTime[s] = now;
                                    }
                                }
                                oiHistory[s] = currentOI;
                            }
                        }
                    }
                }
                render(allData);
            } catch (e) { console.error("æ•¸æ“šæ›´æ–°å‡ºéŒ¯", e); }
        }

        function addLog(s, f, slope, oiChange, isSuper) {
            const container = document.getElementById('logContainer');
            if (container.innerText.includes("ç­‰å¾…è¨Šè™Ÿ")) container.innerHTML = '';
            const entry = document.createElement('div');
            entry.className = `p-3 mb-2 rounded border-l-4 ${isSuper ? 'bg-red-950 border-red-500' : 'bg-zinc-800 border-zinc-500'}`;
            entry.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="font-black text-white text-base">${s.replace('USDT','')}</span>
                    <span class="text-zinc-500 text-[10px]">${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="flex justify-between text-[11px]">
                    <span class="text-red-400">è³‡è²»: ${(f*100).toFixed(4)}%</span>
                    <span class="text-yellow-500">æ–œç‡: ${(slope*100).toFixed(1)}%</span>
                </div>
                <div class="text-[10px] text-green-500 mt-1">OI è®Šå‹•: +${(oiChange*100).toFixed(2)}% (ğŸ”¥å·²ç™¼é€æ¨æ’­)</div>
            `;
            container.prepend(entry);
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="text-zinc-700 italic text-center py-10">æ—¥èªŒå·²æ¸…ç©º</div>';
            lastPushTime = {};
        }

        function removeCoin(s) {
            pinnedCoins = pinnedCoins.filter(c => c !== s);
            delete coinHistory[s];
            render();
        }

        function render(allData = []) {
            const container = document.getElementById('dashboard');
            container.innerHTML = '';
            pinnedCoins.forEach(s => {
                const data = allData.find(c => c.symbol === s);
                const fNow = data ? parseFloat(data.lastFundingRate) : 0;
                const history = coinHistory[s] || [fNow];
                const slope = history.length >= 75 ? (fNow - history[0]) / Math.abs(history[0]) : 0;
                const isHunt = slope <= CONFIG.HUNT_SLOPE;

                const card = document.createElement('div');
                card.className = `p-4 bg-zinc-900 rounded-lg relative overflow-hidden ${isHunt ? 'ambush-card' : 'gold-border'}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="text-[10px] px-2 py-0.5 rounded ${isHunt ? 'bg-red-700 text-white' : 'bg-zinc-800 text-zinc-400'}">
                            ${isHunt ? 'âš¡ çµæ®ºæ¨¡å¼' : 'ğŸ“¡ è§€å¯Ÿä¸­'}
                        </span>
                        <span class="text-[10px] text-zinc-600">ä¸Šæ¦œ: ${joinTime[s]}</span>
                    </div>
                    <div class="flex justify-between items-center mt-3">
                        <h2 class="text-5xl font-black text-white tracking-tighter">${s.replace('USDT','')}</h2>
                        <div class="text-right">
                            <p class="text-2xl font-bold ${fNow < 0 ? 'text-red-500' : 'text-green-500'}">${(fNow * 100).toFixed(4)}%</p>
                            <p class="text-xs text-yellow-600 font-bold">æ–œç‡: ${(slope * 100).toFixed(1)}%</p>
                        </div>
                    </div>
                    <button onclick="removeCoin('${s}')" class="absolute bottom-1 right-2 text-[9px] text-zinc-700 hover:text-white uppercase tracking-widest">Remove</button>
                `;
                container.appendChild(card);
            });
        }
    </script>
</body>
</html>
