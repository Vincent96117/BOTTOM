<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNIPER V3.1 | çµ‚æ¥µæ ¡æº–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: #FFD700; font-family: 'Courier New', monospace; overflow-x: hidden; }
        .gold-border { border: 1px solid #FFD700; }
        .ambush-card { border: 2px solid #ff0000; box-shadow: 0 0 15px #ff0000; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        #logContainer::-webkit-scrollbar { width: 4px; }
        #logContainer::-webkit-scrollbar-thumb { background: #444; }
        .status-on { color: #00ff00; text-shadow: 0 0 8px #00ff00; }
        .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="p-4 border-b border-yellow-900 bg-black flex justify-between items-center shrink-0">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-black text-yellow-500 tracking-tighter">âš¡ SNIPER V3.1</h1>
            <button onclick="toggleSystem()" class="bg-zinc-900 border border-zinc-700 px-4 py-1 rounded-full flex items-center">
                <span id="statusDot" class="dot bg-red-600"></span>
                <span id="statusText" class="text-red-500 text-xs font-bold uppercase">OFFLINE</span>
            </button>
        </div>
        <div class="flex gap-2">
            <button onclick="testPush()" class="text-[10px] bg-blue-900 px-3 py-1 rounded text-white border border-blue-700 font-bold">ğŸ§ª æ¸¬è©¦ä¸‰äººåŒæ­¥</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <main class="flex-1 p-4 overflow-y-auto bg-zinc-950">
            <h2 class="text-sm font-bold mb-4 text-zinc-500 uppercase tracking-widest">ğŸ“¡ Live Monitor (MOM: 2% / SLOPE: 40%)</h2>
            <div id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
        </main>

        <aside class="w-80 border-l border-yellow-900 bg-black flex flex-col">
            <div class="p-4 border-b border-zinc-800 flex justify-between items-center">
                <h2 class="font-bold text-red-500 text-sm">ğŸ“‚ çµæ®ºæ—¥èªŒ</h2>
                <button onclick="clearLogs()" class="text-[10px] text-zinc-600 underline">æ¸…é™¤</button>
            </div>
            <div id="logContainer" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
        </aside>
    </div>

<script>
    const CONFIG = {
        PO_USER: "Gkhqyhobnxzjfwgvaiyp347m1jkhn4", 
        PO_TOKEN: "acyoe3sz15x4n91r1349fdcau7x6pw",
        EXCLUDE: ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'BNBUSDT', 'BNXUSDT'],
        OBSERVE_SLOPE: -0.15, // æ–œç‡ -15% ä¸Šæ¦œ
        HUNT_SLOPE: -0.4,    // ğŸ® æ ¸å¿ƒï¼šæ–œç‡ 40%
        OI_MOMENTUM: 0.02    // ğŸ® æ ¸å¿ƒï¼šå‹•èƒ½ 2%
    };

    let pinnedCoins = [], coinHistory = {}, baseOI = {}, joinTime = {}, lastPushTime = {}, oiHistory = {}; 
    let isRunning = false, timer = null;

    function toggleSystem() {
        isRunning = !isRunning;
        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');
        if (isRunning) {
            dot.className = "dot bg-green-500 shadow-[0_0_8px_#00ff00]";
            text.innerText = "ONLINE (8s)";
            text.className = "status-on text-xs font-bold uppercase";
            updateData();
            timer = setInterval(updateData, 8000);
        } else {
            dot.className = "dot bg-red-600";
            text.innerText = "OFFLINE";
            text.className = "text-red-500 text-xs font-bold uppercase";
            clearInterval(timer);
        }
    }

    async function sendPush(title, message) {
        const params = new URLSearchParams();
        params.append("token", CONFIG.PO_TOKEN);
        params.append("user", CONFIG.PO_USER);
        params.append("title", title);
        params.append("message", message);
        params.append("priority", "1");
        params.append("sound", "classical");
        try {
            await fetch('https://api.pushover.net/1/messages.json', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params.toString()
            });
        } catch(e) { console.error("Push Error", e); }
    }

    async function testPush() {
        await sendPush("Sniper V3.1 æ¸¬è©¦", "ä¸‰ä½æˆ°å‹è«‹æ³¨æ„ï¼Œç¾¤çµ„é€£ç·šæˆåŠŸï¼");
        alert("æ¸¬è©¦è«‹æ±‚å·²ç™¼å‡ºï¼Œè«‹ç¢ºèªä¸‰å°æ‰‹æ©Ÿ...");
    }

    async function getOI(symbol) {
        try {
            const res = await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${symbol}`);
            const data = await res.json();
            return parseFloat(data.openInterest);
        } catch(e) { return null; }
    }

    async function updateData() {
        if (!isRunning) return;
        try {
            const res = await fetch('https://fapi.binance.com/fapi/v1/premiumIndex');
            const allData = await res.json();
            
            for (const coin of allData) {
                const s = coin.symbol;
                if (CONFIG.EXCLUDE.includes(s)) continue;
                const fNow = parseFloat(coin.lastFundingRate);
                
                if (!coinHistory[s]) coinHistory[s] = [];
                coinHistory[s].push(fNow);
                if (coinHistory[s].length > 75) coinHistory[s].shift();

                if (coinHistory[s].length >= 75) {
                    const fPast = coinHistory[s][0];
                    const slope = (fNow - fPast) / Math.abs(fPast);
                    
                    if (fNow <= -0.0003 && slope <= CONFIG.OBSERVE_SLOPE) {
                        if (!pinnedCoins.includes(s)) {
                            pinnedCoins.unshift(s);
                            joinTime[s] = new Date().toLocaleTimeString('zh-TW', {hour12: false});
                            const initialOI = await getOI(s);
                            baseOI[s] = initialOI;
                        }

                        const currentOI = await getOI(s);
                        if (currentOI && baseOI[s]) {
                            const totalGrowth = (currentOI - baseOI[s]) / baseOI[s];
                            
                            // ğŸ® çµæ®ºåˆ¤å®šï¼š40% æ–œç‡ + 2% å‹•èƒ½
                            if (slope <= CONFIG.HUNT_SLOPE && totalGrowth >= CONFIG.OI_MOMENTUM) {
                                const now = Date.now();
                                if (!lastPushTime[s] || (now - lastPushTime[s] > 1800000)) {
                                    // é—œéµï¼šå…ˆå¯«æ—¥èªŒï¼Œä¿è­‰ UI ä¸€å®šæœ‰åæ‡‰
                                    addLog(s, fNow, slope, totalGrowth);
                                    // å¾Œç™¼æ¨æ’­
                                    sendPush(`ğŸ”¥çµæ®º: ${s.replace('USDT','')}`, `è³‡è²»: ${(fNow*100).toFixed(4)}%\nå‹•èƒ½: +${(totalGrowth*100).toFixed(1)}%\næ–œç‡: ${(slope*100).toFixed(1)}%`);
                                    lastPushTime[s] = now;
                                }
                            }
                            oiHistory[s] = currentOI;
                        }
                    }
                }
            }
            render(allData);
        } catch (e) { console.error(e); }
    }

    function addLog(s, f, slope, growth) {
        const container = document.getElementById('logContainer');
        const entry = document.createElement('div');
        entry.className = "p-3 bg-zinc-900 border-l-4 border-red-600 mb-2";
        entry.innerHTML = `
            <div class="flex justify-between text-white font-bold mb-1">
                <span>${s.replace('USDT','')}</span>
                <span class="text-[10px] text-zinc-500">${new Date().toLocaleTimeString()}</span>
            </div>
            <div class="text-[10px] text-red-400">å‹•èƒ½: +${(growth*100).toFixed(1)}% | æ–œç‡: ${(slope*100).toFixed(1)}%</div>
            <div class="text-[10px] text-yellow-500 mt-1 font-bold italic">ğŸ¯ è¡Œæƒ…ç™¼å‹•</div>
        `;
        container.prepend(entry);
    }

    function render(allData = []) {
        const container = document.getElementById('dashboard');
        container.innerHTML = '';
        pinnedCoins.forEach(s => {
            const data = allData.find(c => c.symbol === s);
            const fNow = data ? parseFloat(data.lastFundingRate) : 0;
            const slope = coinHistory[s].length >= 75 ? (fNow - coinHistory[s][0]) / Math.abs(coinHistory[s][0]) : 0;
            const growth = baseOI[s] ? (oiHistory[s] - baseOI[s]) / baseOI[s] : 0;
            const isHunt = slope <= CONFIG.HUNT_SLOPE && growth >= CONFIG.OI_MOMENTUM;

            const card = document.createElement('div');
            card.className = `p-4 bg-zinc-900 rounded ${isHunt ? 'ambush-card' : 'gold-border'}`;
            card.innerHTML = `
                <div class="flex justify-between items-center text-[9px] mb-2 uppercase tracking-widest font-bold">
                    <span class="${isHunt ? 'text-red-500' : 'text-zinc-500'}">${isHunt ? '!! HUNTING !!' : 'Observing'}</span>
                    <span class="text-zinc-600">IN: ${joinTime[s]}</span>
                </div>
                <div class="flex justify-between items-center">
                    <h2 class="text-4xl font-black text-white">${s.replace('USDT','')}</h2>
                    <div class="text-right">
                        <p class="text-lg font-bold text-red-500">${(fNow * 100).toFixed(4)}%</p>
                        <p class="text-[10px] text-yellow-600 font-bold">å‹•èƒ½: +${(growth * 100).toFixed(1)}%</p>
                    </div>
                </div>
                <div class="mt-2 text-[9px] text-zinc-700 italic border-t border-zinc-800 pt-2 flex justify-between">
                    <span>SNIPER V3.1</span>
                    <button onclick="removeCoin('${s}')" class="underline hover:text-white">REMOVE</button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function removeCoin(s) { pinnedCoins = pinnedCoins.filter(c => c !== s); render(); }
    function clearLogs() { document.getElementById('logContainer').innerHTML = ''; }
</script>
</body>
</html>
